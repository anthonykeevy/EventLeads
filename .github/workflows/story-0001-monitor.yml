name: Story 0001 Change Monitor

# Monitor changes to Story 0001 core files and alert when regression testing may be needed
on:
  pull_request:
    paths:
      # Backend Core Files
      - 'backend/app/routers/auth.py'
      - 'backend/app/models/user.py'
      - 'backend/app/models/emailverificationtoken.py'
      - 'backend/app/models/passwordresettoken.py'
      - 'backend/app/models/authevent.py'
      - 'backend/app/utils/security.py'
      - 'backend/app/schemas/auth.py'
      - 'backend/app/core/settings.py'
      
      # Frontend Core Files
      - 'frontend/src/app/signup/page.tsx'
      - 'frontend/src/app/login/page.tsx'
      - 'frontend/src/app/verify/page.tsx'
      - 'frontend/src/app/resend/page.tsx'
      - 'frontend/src/app/reset/request/page.tsx'
      - 'frontend/src/app/reset/confirm/page.tsx'
      - 'frontend/src/lib/auth.ts'
      - 'frontend/src/lib/api.ts'
      
      # Configuration Files
      - '.env.dev'
      - 'docs/shards/02-data-schema.md'
      
      # Database Migrations
      - 'backend/migrations/versions/a013_*.py'
      
      # Documentation Files
      - 'docs/stories/0001-auth-org-foundation.md'
      - 'docs/story-0001-uat-signoff-checklist.md'
      - 'docs/story-0001-implementation-walkthrough.md'

  push:
    branches: [ main, develop ]
    paths:
      # Same paths as pull_request

jobs:
  story-0001-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit for comparison
    
    - name: Detect Story 0001 changes
      id: detect-changes
      run: |
        echo "🔍 Checking for Story 0001 file changes..."
        
        # Get list of changed files
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        
        # Story 0001 core files
        STORY_0001_FILES=(
          "backend/app/routers/auth.py"
          "backend/app/models/user.py"
          "backend/app/models/emailverificationtoken.py"
          "backend/app/models/passwordresettoken.py"
          "backend/app/models/authevent.py"
          "backend/app/utils/security.py"
          "backend/app/schemas/auth.py"
          "backend/app/core/settings.py"
          "frontend/src/app/signup/page.tsx"
          "frontend/src/app/login/page.tsx"
          "frontend/src/app/verify/page.tsx"
          "frontend/src/app/resend/page.tsx"
          "frontend/src/app/reset/request/page.tsx"
          "frontend/src/app/reset/confirm/page.tsx"
          "frontend/src/lib/auth.ts"
          "frontend/src/lib/api.ts"
          ".env.dev"
          "docs/shards/02-data-schema.md"
          "docs/stories/0001-auth-org-foundation.md"
          "docs/story-0001-uat-signoff-checklist.md"
          "docs/story-0001-implementation-walkthrough.md"
        )
        
        # Check for Story 0001 file changes
        STORY_0001_CHANGES=""
        for file in "${STORY_0001_FILES[@]}"; do
          if echo "$CHANGED_FILES" | grep -q "^$file$"; then
            STORY_0001_CHANGES="$STORY_0001_CHANGES$file"$'\n'
          fi
        done
        
        # Also check for migration files
        MIGRATION_CHANGES=$(echo "$CHANGED_FILES" | grep "backend/migrations/versions/a013_" || true)
        if [ -n "$MIGRATION_CHANGES" ]; then
          STORY_0001_CHANGES="$STORY_0001_CHANGES$MIGRATION_CHANGES"$'\n'
        fi
        
        if [ -n "$STORY_0001_CHANGES" ]; then
          echo "🚨 Story 0001 files modified!"
          echo "STORY_0001_CHANGED=true" >> $GITHUB_OUTPUT
          echo "STORY_0001_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$STORY_0001_CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "✅ No Story 0001 files modified"
          echo "STORY_0001_CHANGED=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment on PR (if Story 0001 files changed)
      if: github.event_name == 'pull_request' && steps.detect-changes.outputs.STORY_0001_CHANGED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const changedFiles = `${{ steps.detect-changes.outputs.STORY_0001_FILES }}`;
          
          const comment = `## 🚨 Story 0001 Files Modified
          
          **Warning**: This PR modifies files that are part of Story 0001 (Auth & Org Foundation). Regression testing is recommended.
          
          ### Modified Files:
          ${changedFiles.split('\n').filter(f => f.trim()).map(f => `- \`${f}\``).join('\n')}
          
          ### 📋 Recommended Actions:
          1. **Run UAT Testing**: Review [UAT Checklist](docs/story-0001-uat-signoff-checklist.md)
          2. **Test Auth Flows**: Signup → Verify → Login → Reset
          3. **Verify Rate Limiting**: Test resend and reset limits
          4. **Check Security**: Verify JWT, tokens, and audit logging
          5. **Update Documentation**: Reflect any changes made
          
          ### 🧪 Quick Test Commands:
          \`\`\`bash
          # Check service status
          .\\scripts\\story-0001-uat-helper.ps1 -Action status
          
          # Test API endpoints
          .\\scripts\\story-0001-uat-helper.ps1 -Action api
          \`\`\`
          
          ### 📚 Documentation:
          - [Story 0001 Signoff](docs/story-0001-signoff-complete.md)
          - [Implementation Guide](docs/story-0001-implementation-walkthrough.md)
          - [UAT Checklist](docs/story-0001-uat-signoff-checklist.md)
          
          ---
          *This comment was automatically generated by the Story 0001 Change Monitor*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Create Issue (if Story 0001 files changed on main/develop)
      if: github.event_name == 'push' && steps.detect-changes.outputs.STORY_0001_CHANGED == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const changedFiles = `${{ steps.detect-changes.outputs.STORY_0001_FILES }}`;
          const branch = context.ref.replace('refs/heads/', '');
          
          const title = `🚨 Story 0001 Files Modified on ${branch}`;
          const body = `## Story 0001 Files Modified
          
          **Branch**: \`${branch}\`  
          **Commit**: \`${context.sha}\`  
          **Date**: ${new Date().toISOString()}
          
          ### Modified Files:
          ${changedFiles.split('\n').filter(f => f.trim()).map(f => `- \`${f}\``).join('\n')}
          
          ### 📋 Recommended Actions:
          1. **Run Regression Testing**: Review [UAT Checklist](docs/story-0001-uat-signoff-checklist.md)
          2. **Test Auth Flows**: Signup → Verify → Login → Reset
          3. **Verify Rate Limiting**: Test resend and reset limits
          4. **Check Security**: Verify JWT, tokens, and audit logging
          5. **Update Documentation**: Reflect any changes made
          
          ### 🧪 Quick Test Commands:
          \`\`\`bash
          # Check service status
          .\\scripts\\story-0001-uat-helper.ps1 -Action status
          
          # Test API endpoints
          .\\scripts\\story-0001-uat-helper.ps1 -Action api
          \`\`\`
          
          ### 📚 Documentation:
          - [Story 0001 Signoff](docs/story-0001-signoff-complete.md)
          - [Implementation Guide](docs/story-0001-implementation-walkthrough.md)
          - [UAT Checklist](docs/story-0001-uat-signoff-checklist.md)
          
          ---
          *This issue was automatically created by the Story 0001 Change Monitor*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['story-0001', 'regression-testing', 'auth-system']
          });
    
    - name: Summary
      run: |
        if [ "${{ steps.detect-changes.outputs.STORY_0001_CHANGED }}" == "true" ]; then
          echo "🚨 Story 0001 files were modified - regression testing recommended"
          echo "📋 UAT Checklist: docs/story-0001-uat-signoff-checklist.md"
          echo "📚 Signoff Document: docs/story-0001-signoff-complete.md"
        else
          echo "✅ No Story 0001 files were modified"
        fi
